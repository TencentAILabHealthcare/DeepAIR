# preprocessing_structure_feature in DeepAIR

[![python >3.8.13](https://img.shields.io/badge/python-3.8.13-brightgreen)](https://www.python.org/) 

## Software requirements

### OS requirements
This tool is supported for Linux. The tool has been tested on the following systems: <br>
+ CentOS Linux release 8.2.2.2004
+ Ubuntu 18.04.5 LTS

### Python dependencies

preprocessing_structure_feature needs alphafold2, the detailed information of alphafold2 is given: https://github.com/deepmind/alphafold

+ Other packages including:
```
    umap-learn                   0.5.1
    scikit-learn                 0.23.2
    biopython                    1.76    
    matplotlib                   3.5.1
    numpy                        1.19.5
    pandas                       1.4.2
```

# step 1 
Generate the corresponding fasta file for each chain and identify the begining position and end position of the CDR3 region in each alpha/light and beta/heavy chains. 

```python
python step1.py \
    --AIR_file_path ./sampledata/CoV-AbDab_example.csv \ # path to the input AIR file
    --output_table ./sampledata/CoV-AbDab_example_CDR3Region.csv \ # path to save the output table
    --output_fasta_folder ./sampledata/fasta \ # folder to save the output fasta files
```
In step1, a fasta folder and a csv file containing CDR3Region information will be generated. Each chain is denoted with its CDR3 region and an unique ID (Can be assigned by the user).

# step 2 
First, we need to deploy alphafold2:

https://github.com/deepmind/alphafold

In order to get the representations from af2 in "features.pkl", you should add "return_representations=True" in line 79 and line 87 of ./alphafold/alphafold/model/model.py before building the image.

Then, set Data_dir in step2.sh to the path of the dataset you downloaded, and run step2.sh:
```bash
bash step2.sh
```
Then you can get the "features.pkl", "relaxed_model_1_ptm.pdb" and other files generated by af2 in the output folder.

# step 3 
Extract the structure feature of the CDR3 region of BCR heavy/light or TCR alpha/beta chains.
```python
python step3.py \
    --AIR_file_path ./sampledata/CoV-AbDab_example_CDR3Region.csv \ # path to the vdj file
    --AF2_feature_folder ./sampledata/output_af2_structure \ # path to the AF2 feature folder
    --output_folder ./sampledata/output_feature \ # path to the output table
```
At step 3, we can get the CDR3 structure feature files, which can be used and recalibated by DeepAIR.


# step 4 (Optional)
Get the structure file (PDB file) of the CDR3 region of BCR heavy/light or TCR alpha/beta chains.

```python
python step4.py \ 
    --AF2_feature_folder ./sampledata/output_af2_structure \ # path to the AF2 feature folder list
    --table_file_path ./sampledata/CoV-AbDab_example_CDR3Region.csv \ # path to the table file
    --output_folder ./sampledata/output_pdb \ # path to the output folder
```
At the end of the step, we can get the pdb file for the CDR3 regions